{% extends "layout.html" %}
{% block title %}Tracks{% endblock %}

<!-- content -->
{% block content %}
{% from "_table_helper.html" import render_table %}
{% from "sort_filter.html" import sort_filter %}
{% set view = "tracks.view" %}
{% set edit = "tracks.edit" %}
{% set delete = "tracks.delete" %}
{% set list_playlist = "tracks.list_playlist" %}
{% set admin_add = "tracks.admin_add_to_playlist" %}
<div class="container-fluid">
    <div class="h1 text-center">Tracks</div>

    <form method="GET">
        <div class="row">
            <!-- Search -->
            <div class="col-md-2">
                <label class="form-label visually-hidden" for="search">Search Name</label>
                <input type="text" name="search" class="form-control" id="search" placeholder="Search by Track Name, Artist, Album"
                    value="{{ request.args.get('Name') or request.args.get('Artist') or request.args.get('Album') or '' }}">
            </div>
            <!-- Track Name -->
            <div class="col">
                <label class="form-label visually-hidden" for="title">Track Name</label>
                <input type="text" name="title" class="form-control" id="title" placeholder="Track Name"
                    value="{{ request.args.get('Name') or '' }}">
            </div>
            <!-- Track Short Name -->
            <div class="col">
                <label class="form-label visually-hidden" for="track_short_name">Short Name</label>
                <input type="text" name="track_short_name" class="form-control" id="track_short_name" placeholder="Short Name"
                    value="{{ request.args.get('track_short_name') or '' }}">
            </div>

            <div class="col">
                <label class="form-label visually-hidden" for="duration">Duration</label>
                <input class="form-control" type="number" min="1" id="duration" name="duration"
                    placeholder="Duration" value="{{ request.args.get('duration') or '' }}" />
            </div>
            <!-- Artist -->
            <div class="col">
                <label class="form-label visually-hidden" for="artist">Artist</label>
                <input type="text" name="artist" class="form-control" id="artist" placeholder="Artist"
                    value="{{ request.args.get('artist') or '' }}">
            </div>
    
            <!-- Sort Filter -->
            {{ sort_filter(cols=[
                ("title", "Track Name"),
                ("title_short", "Short Name"),
                ("duration", "Duration"),
                ("rank", "Rank"),
                ("artist_name", "Artist"),
                ("album_name", "Album"),
                ("created", "Created"),
                ("modified", "Modified")
            ]) }}
            <!-- Limit Filter -->
            <div class="col">
                <label class="form-label visually-hidden" for="limit">Limit</label>
                <input class="form-control" type="number" min="1" max="100" id="limit" name="limit"
                    value="{{ request.args.get('limit') or '10' }}" />
            </div>
            <!-- Filter and Reset Buttons -->
            <div class="col">
                <input type="submit" class="btn btn-primary" value="Filter" />
                <a href="?" class="btn btn-secondary">Reset</a>
            </div>
        </div>
    </form>
    <!-- Pagination -->
    
    <table class="table">
    {% if rows and rows|length > 0 %}
    <thead>
        <tr class="text-capitalize">
            {# generate th tags for each column to display #}
            {# don't show any id or organization_id columns #}
            {# IMPORTANT use table column names as the headings, replace _ with space via filter #}
            <!-- add th elements -->
            {% for r in rows[0] %}
                {% if r == 'track_link' %}
                    <th>Track Link</th>
                {% elif r not in ['ID', 'readable' ,'modified', 'created'] %}
                    <th>{{ r }}</th>
                {% endif %}
            {% endfor %}
            <!-- keep this -->
            <th>Actions</th>
        </tr>
    </thead>
    
    <tbody>
        {# generate tr with td tags for each piece of data #}
        {# don't show any id or organization_id columns #}
        {# in the last column add the following
        an edit button that passes the donation id to donation edit
        a delete button that passes the donation id and the request args to the donation delete route
        #}
        {% for r in rows %}
        <tr>
                {% for key, value in r.items() %}
                    {% if key not in ['ID', 'readable', 'modified', 'created'] %}
                        {% if key == 'Track Link' %}
                            <td><a href="{{ value }}" target="_blank">{{ value }}</a></td>
                        {% else %}
                            <td>{{ value }}</td>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                <td>
                    <a href="{{ url_for(view, id=r.ID) }}">View</a>
                    {% if current_user.has_role("Admin") %}
                    <a href="{{ url_for(admin_add, track_id=r.ID, playlist_id = request.args.get('playlist_id'), user_id = request.args.get('user_id') ) }}">Add to Playlist</a>
                    {% else %}
                    <a href="{{ url_for(list_playlist, id=r.ID) }}">Add to Playlist</a>
                    {% endif %}
                    {% if current_user.has_role("Manager") %}
                        <a href="{{ url_for(edit, id=r.ID) }}">Edit</a>
                    {% endif %}
                    {% if current_user.has_role("Admin") %}
                        <a href="{{ url_for(delete, id=r.ID, **request.args) }}">Delete</a>
                    {% endif %}
                </td>
        </tr>

        <!-- iterate over rows and generate proper tr and td elements with the data -->

    </tbody>
    {% endfor %}
    {% else %}
    <tbody>
        <tr>
            <td colspan="100%">No results to show</td>
        </tr>
    </tbody>
    {% endif %}
</table> 
<div class="d-flex justify-content-center mt-3">
    {% if total_pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% for num in range(1, total_pages + 1) %}
                    <li class="page-item {% if num == current_page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('tracks.list', page=num, search=request.args.get('search'), title=request.args.get('title'), title_short=request.args.get('title_short'), duration=request.args.get('duration'), artist=request.args.get('artist'), album_name=request.args.get('album_name'), column=request.args.get('column'), order=request.args.get('order'), limit=request.args.get('limit')) }}">{{ num }}</a>
                    </li>
                {% endfor %}
            </ul>
        </nav>
    {% endif %}
</div>

<!-- Records info -->
<div class="d-flex justify-content-between mt-3">
    <div class="text-muted mt-3">
        Showing {{ rows|length }}/{{ total_rows }} records
    </div>
    <div class="text-muted">
        Page {{ current_page }}/{{ total_pages }}
    </div>
</div>
</div>

{% endblock %}